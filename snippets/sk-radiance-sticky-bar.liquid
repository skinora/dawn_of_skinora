{%- comment -%}
  Snippet: sk-radiance-sticky-bar
  FINAL FIX:
  - No inline transforms
  - CSS controls animation
  - Scroll-triggered visibility
  - Correct offer sync
  - No regressions
{%- endcomment -%}

<style>
  /* =============================
     STICKY BAR (PORTAL)
  ============================== */

  .sk-radiance-sticky-bottom-bar--portal {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 2147483000;

    background: linear-gradient(90deg, #c9c6cc, #30273e);
    color: #fff;
    height: 64px;

    display: flex;
    align-items: center;

    box-shadow: 0 -6px 24px rgba(0, 0, 0, 0.18);

    transform: translateY(100%);
    transition: transform 0.28s ease;
  }

  .sk-radiance-sticky-bottom-bar--portal.visible {
    transform: translateY(0);
  }

  .sk-radiance-sticky-bottom-bar {
    width: 100%;
    max-width: 1280px;
    margin: 0 auto;
    padding: 0 1.25rem;

    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1.25rem;
  }

  .sk-radiance-sticky-bottom-bar__title {
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 38ch;
  }

  .sk-radiance-sticky-bottom-bar__price {
    display: flex;
    flex-direction: column;
    line-height: 1;
  }

  .sk-price__value {
    font-size: 0.8rem;
    opacity: 0.85;
  }

  .sk-price__current {
    font-size: 1.25rem;
    font-weight: 600;
  }

  .sk-radiance-sticky-bottom-bar__cta {
    background: #30273e;
    color: #fff;
    border: 0;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    cursor: pointer;
  }
</style>

{%- liquid
  assign section_id = section.id
  assign add_label = 'products.product.add_to_cart' | t
  assign sold_out_label = 'products.product.sold_out' | t
-%}

<!-- SOURCE TEMPLATE -->
<div id="stickyBottomBar-{{ section_id }}" style="display:none">
  <div class="sk-radiance-sticky-bottom-bar" data-sk-sticky>
    <div class="sk-radiance-sticky-bottom-bar__title" data-sk-sticky-title>
      {{ product.title }}
    </div>

    <div class="sk-radiance-sticky-bottom-bar__price">
      <span class="sk-price__value"></span>
      <span class="sk-price__current"></span>
    </div>

    <input type="hidden" data-sk-sticky-variant>

    <button
      type="button"
      class="sk-radiance-sticky-bottom-bar__cta"
      data-sk-sticky-cta
      data-product-form="{{ product_form_id }}"
      disabled
    >
      {{ add_label }}
    </button>
  </div>
</div>

<script>
  (function () {
    const sectionId = '{{ section_id }}';
    const sourceId = 'stickyBottomBar-' + sectionId;
    const portalId = sourceId + '-portal';
    const hero = document.querySelector('#MainProduct-' + sectionId);

    function formatMoney(cents) {
      return Shopify?.formatMoney ? Shopify.formatMoney(cents) : (cents / 100).toFixed(2);
    }

    function mountPortal() {
      const source = document.getElementById(sourceId);
      if (!source) return null;

      let portal = document.getElementById(portalId);
      if (!portal) {
        portal = document.createElement('div');
        portal.id = portalId;
        portal.className = 'sk-radiance-sticky-bottom-bar--portal';
        portal.innerHTML = source.innerHTML;
        document.body.appendChild(portal);
      }
      return portal;
    }

    function updateVisibility(portal) {
      if (!hero) return;
      const rect = hero.getBoundingClientRect();
      portal.classList.toggle('visible', rect.bottom < 80);
    }

    function updateSticky(detail) {
      const portal = document.getElementById(portalId);
      if (!portal || !detail) return;

      portal.querySelector('[data-sk-sticky-title]').textContent = detail.title;
      portal.querySelector('.sk-price__current').textContent = formatMoney(detail.price);
      portal.querySelector('.sk-price__value').textContent =
        detail.compare_at_price > detail.price ? 'Verdi ' + formatMoney(detail.compare_at_price) : '';

      const btn = portal.querySelector('[data-sk-sticky-cta]');
      btn.disabled = !detail.available;
      btn.textContent = detail.available ? '{{ add_label }}' : '{{ sold_out_label }}';
    }

    const portal = mountPortal();
    if (!portal) return;

    window.addEventListener('scroll', () => updateVisibility(portal), { passive: true });
    window.addEventListener('resize', () => updateVisibility(portal));

    document.addEventListener('sk:offerchange', (e) => updateSticky(e.detail));
  })();
</script>
