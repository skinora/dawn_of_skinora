{%- comment -%}
  Cleaned product card price + quick-add snippet.
  Keeps the original behavior but uses standard Liquid tags to avoid parsing issues.
{%- endcomment -%}

<div class="card__content">
  <div class="card__information">
    <h3
      class="card__heading{% if card_product.featured_media or settings.card_style == 'standard' %} h5{% endif %}"
      {% if card_product.featured_media or settings.card_style == 'card' %}
        id="title-{{ section_id }}-{{ card_product.id }}"
      {% endif %}
    >
      <a
        href="{{ card_product.url }}"
        id="CardLink-{{ section_id }}-{{ card_product.id }}"
        class="full-unstyled-link"
        aria-labelledby="CardLink-{{ section_id }}-{{ card_product.id }} Badge-{{ section_id }}-{{ card_product.id }}"
      >
        {{- card_product.title | escape -}}
      </a>
    </h3>

    <div class="card-information">
      {% if show_vendor %}
        <span class="visually-hidden">{{ 'accessibility.vendor' | t }}</span>
        <div class="caption-with-letter-spacing light">{{ card_product.vendor }}</div>
      {% endif %}

      <span class="caption-large light">{{ block.settings.description | escape }}</span>

      {% if show_rating and card_product.metafields.reviews.rating.value != blank %}
        {% assign rating_decimal = 0 %}
        {% assign decimal = card_product.metafields.reviews.rating.value.rating | modulo: 1 %}
        {% if decimal >= 0.3 and decimal <= 0.7 %}
          {% assign rating_decimal = 0.5 %}
        {% elsif decimal > 0.7 %}
          {% assign rating_decimal = 1 %}
        {% endif %}
        <div
          class="rating"
          role="img"
          aria-label="{{ 'accessibility.star_reviews_info' | t: rating_value: card_product.metafields.reviews.rating.value, rating_max: card_product.metafields.reviews.rating.value.scale_max }}"
        >
          <span
            aria-hidden="true"
            class="rating-star"
            style="--rating: {{ card_product.metafields.reviews.rating.value.rating | floor }}; --rating-max: {{ card_product.metafields.reviews.rating.value.scale_max }}; --rating-decimal: {{ rating_decimal }};"
          ></span>
        </div>
        <p class="rating-text caption">
          <span aria-hidden="true">
            {{- card_product.metafields.reviews.rating.value }} /
            {{ card_product.metafields.reviews.rating.value.scale_max -}}
          </span>
        </p>
        <p class="rating-count caption">
          <span aria-hidden="true">({{ card_product.metafields.reviews.rating_count }})</span
          ><span class="visually-hidden">
            {{- card_product.metafields.reviews.rating_count }}
            {{ 'accessibility.total_reviews' | t -}}
          </span>
        </p>
      {% endif %}

      {% render 'price', product: card_product, price_class: '', show_compare_at_price: true %}

      {% if card_product.quantity_price_breaks_configured? %}
        {% if card_product.variants_count == 1 and quick_add == 'bulk' %}
          {% assign quantity_rule = card_product.selected_or_first_available_variant.quantity_rule %}
          {% assign has_qty_rules = false %}
          {% if quantity_rule.increment > 1 or quantity_rule.min > 1 or quantity_rule.max != null %}
            {% assign has_qty_rules = true %}
          {% endif %}
          <quantity-popover>
            <button class="card__information-volume-pricing-note card__information-volume-pricing-note--button card__information-volume-pricing-note--button-{{ settings.card_text_alignment }} quantity-popover__info-button--icon-only button button button--tertiary medium-hide small-hide">
              <span class="caption">{{ 'products.product.volume_pricing.note' | t }}</span>
            </button>
            <button class="card__information-volume-pricing-note card__information-volume-pricing-note--button card__information-volume-pricing-note--button-{{ settings.card_text_alignment }} quantity-popover__info-button--icon-with-label button button--tertiary large-up-hide">
              <span class="caption">{{ 'products.product.volume_pricing.note' | t }}</span>
            </button>
            <div
              class="global-settings-popup quantity-popover__info"
              tabindex="-1"
              hidden
              id="quantity-popover-info-{{ card_product.selected_or_first_available_variant.id }}"
            >
              {% if has_qty_rules %}
                <div class="quantity__rules caption no-js-hidden">
                  {% if quantity_rule.increment > 1 -%}
                    <span class="divider">
                      {{- 'products.product.quantity.multiples_of' | t: quantity: quantity_rule.increment -}}
                    </span>
                  {%- endif %}
                  {% if quantity_rule.min > 1 -%}
                    <span class="divider">
                      {{- 'products.product.quantity.min_of' | t: quantity: quantity_rule.min -}}
                    </span>
                  {%- endif %}
                  {% if quantity_rule.max != null -%}
                    <span class="divider">
                      {{- 'products.product.quantity.max_of' | t: quantity: quantity_rule.max -}}
                    </span>
                  {%- endif %}
                </div>
              {% endif %}
              <button
                class="button-close button button--tertiary large-up-hide"
                type="button"
                aria-label="{{ 'accessibility.close' | t }}"
              >
                {{- 'icon-close.svg' | inline_asset_content -}}
              </button>
              {% if card_product.selected_or_first_available_variant.quantity_price_breaks.size > 0 %}
                <volume-pricing class="parent-display">
                  <ul class="list-unstyled">
                    <li>
                      <span>{{ card_product.selected_or_first_available_variant.quantity_rule.min }}+</span>
                      {% assign price = card_product.selected_or_first_available_variant.price | money_with_currency %}
                      <span>{{ 'sections.quick_order_list.each' | t: money: price }}</span>
                    </li>
                    {% for price_break in card_product.selected_or_first_available_variant.quantity_price_breaks %}
                      <li>
                        <span>
                          {{- price_break.minimum_quantity -}}
                          <span aria-hidden="true">+</span></span
                        >
                        {% assign price = price_break.price | money_with_currency %}
                        <span>{{ 'sections.quick_order_list.each' | t: money: price }}</span>
                      </li>
                    {% endfor %}
                  </ul>
                </volume-pricing>
              {% endif %}
            </div>
          </quantity-popover>
        {% else %}
          <div class="card__information-volume-pricing-note">
            <span class="caption">{{ 'products.product.volume_pricing.note' | t }}</span>
          </div>
        {% endif %}
      {% endif %}
    </div>
  </div>

  {% assign product_form_id = 'quick-add-' | append: section_id | append: card_product.id %}
  {% if quick_add == 'standard' %}
    <div class="quick-add no-js-hidden">
      {% assign qty_rules = false %}
      {% if card_product.selected_or_first_available_variant.quantity_rule.min > 1
        or card_product.selected_or_first_available_variant.quantity_rule.max != null
        or card_product.selected_or_first_available_variant.quantity_rule.increment > 1
      %}
        {% assign qty_rules = true %}
      {% endif %}

      {% if card_product.variants_count > 1 or qty_rules %}
        <modal-opener data-modal="#QuickAdd-{{ card_product.id }}">
          <button
            id="{{ product_form_id }}-submit"
            type="submit"
            name="add"
            class="quick-add__submit button button--full-width button--secondary{% if horizontal_quick_add %} card--horizontal__quick-add animate-arrow{% endif %}"
            aria-haspopup="dialog"
            aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
            data-product-url="{{ card_product.url }}"
          >
            {{ 'products.product.choose_options' | t }}
            {% if horizontal_quick_add -%}
              <span class="icon-wrap">{{- 'icon-arrow.svg' | inline_asset_content -}}</span>
            {%- endif %}
            {% render 'loading-spinner' %}
          </button>
        </modal-opener>
        <quick-add-modal id="QuickAdd-{{ card_product.id }}" class="quick-add-modal">
          <div
            role="dialog"
            aria-label="{{ 'products.product.choose_product_options' | t: product_name: card_product.title | escape }}"
            aria-modal="true"
            class="quick-add-modal__content global-settings-popup"
            tabindex="-1"
          >
            <button
              id="ModalClose-{{ card_product.id }}"
              type="button"
              class="quick-add-modal__toggle"
              aria-label="{{ 'accessibility.close' | t }}"
            >
              {{- 'icon-close.svg' | inline_asset_content -}}
            </button>
            <div id="QuickAddInfo-{{ card_product.id }}" class="quick-add-modal__content-info"></div>
          </div>
        </quick-add-modal>
      {% else %}
        <product-form data-section-id="{{ section.id }}">
          {% form 'product',
            card_product,
            id: product_form_id,
            class: 'form',
            novalidate: 'novalidate',
            data-type: 'add-to-cart-form'
          %}
            <input
              type="hidden"
              name="id"
              value="{{ card_product.selected_or_first_available_variant.id }}"
              class="product-variant-id"
              {% if card_product.selected_or_first_available_variant.available == false %}
                disabled
              {% endif %}
            >
            <button
              id="{{ product_form_id }}-submit"
              type="submit"
              name="add"
              class="quick-add__submit button button--full-width button--secondary{% if horizontal_quick_add %} card--horizontal__quick-add{% endif %}"
              aria-haspopup="dialog"
              aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
              aria-live="polite"
              data-sold-out-message="true"
              {% if card_product.selected_or_first_available_variant.available == false %}
                disabled
              {% endif %}
            >
              <span>
                {%- if card_product.selected_or_first_available_variant.available -%}
                  {{- 'products.product.add_to_cart' | t -}}
                {%- else -%}
                  {{- 'products.product.sold_out' | t -}}
                {%- endif -%}
              </span>
              <span class="sold-out-message hidden">{{ 'products.product.sold_out' | t }}</span>
              {% if horizontal_quick_add -%}
                <span class="icon-wrap">{{- 'icon-plus.svg' | inline_asset_content -}}</span>
              {%- endif %}
              {% render 'loading-spinner' %}
            </button>
          {% endform %}
        </product-form>
      {% endif %}
    </div>
  {% elsif quick_add == 'bulk' %}
    {% if card_product.variants_count == 1 %}
      <quick-add-bulk
        data-min="{{ card_product.selected_or_first_available_variant.quantity_rule.min }}"
        id="quick-add-bulk-{{ card_product.selected_or_first_available_variant.id }}-{{ section.id }}"
        class="quick-add-bulk"
        data-index="{{ card_product.selected_or_first_available_variant.id }}"
      >
        {% if card_product.selected_or_first_available_variant.available == false %}
          <button
            id="{{ product_form_id }}-submit"
            type="submit"
            name="add"
            class="quick-add__submit button button--full-width button--secondary"
            aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
            data-sold-out-message="true"
            disabled
          >
            <span>{{ 'products.product.sold_out' | t }}</span
            ><span class="sold-out-message hidden">{{ 'products.product.sold_out' | t }}</span>
          </button>
        {% else %}
          {% render 'quantity-input', variant: card_product.selected_or_first_available_variant, min: 0 %}
        {% endif %}
      </quick-add-bulk>
    {% else %}
      <div class="quick-add no-js-hidden">
        {% assign product_form_id = 'quick-add-' | append: section_id | append: card_product.id %}
        {% assign qty_rules = false %}
        {% if card_product.selected_or_first_available_variant.quantity_rule.min > 1
          or card_product.selected_or_first_available_variant.quantity_rule.max != null
          or card_product.selected_or_first_available_variant.quantity_rule.increment > 1
        %}
          {% assign qty_rules = true %}
        {% endif %}
        <modal-opener
          id="QuickBulk-{{ card_product.id }}-{{ section_id }}"
          data-modal="#QuickAddBulk-{{ card_product.id }}-{{ section.id }}"
        >
          <button
            id="{{ product_form_id }}-submit"
            type="submit"
            name="add"
            class="quick-add__submit button button--full-width button--secondary"
            aria-haspopup="dialog"
            aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
            data-product-url="{{ card_product.url }}"
          >
            {{ 'products.product.choose_options' | t -}}
            {%- render 'loading-spinner' %}
          </button>
        </modal-opener>
        <modal-dialog
          id="QuickAddBulk-{{ card_product.id }}-{{ section_id }}"
          class="quick-add-modal color-{{ section.settings.color_scheme }}"
        >
          <div
            role="dialog"
            aria-label="{{ 'products.product.choose_product_options' | t: product_name: card_product.title | escape }}"
            aria-modal="true"
            class="quick-add-modal__content quick-add-modal__content--bulk global-settings-popup"
            tabindex="-1"
          >
            <button
              id="ModalClose-{{ card_product.id }}"
              type="button"
              class="quick-add-modal__toggle"
              aria-label="{{ 'accessibility.close' | t }}"
            >
              {{- 'icon-close.svg' | inline_asset_content -}}
            </button>
            <div
              id="QuickAddInfo-{{ card_product.id }}"
              class="quick-add-modal__content-info quick-add-modal__content-info--bulk"
            >
              <div class="quick-add__content-info__media">
                <div class="quick-add__info">
                  {% render 'card-product-image',
                    card_product: card_product,
                    media_aspect_ratio: media_aspect_ratio,
                    image_shape: image_shape,
                    lazy_load: lazy_load,
                    settings: settings,
                    section_id: section_id,
                    show_secondary_image: show_secondary_image
                  %}
                </div>
              </div>
              <div>
                <bulk-modal
                  id="QuickBulkModal-{{ card_product.id }}-{{ section_id }}"
                  data-url="{{ card_product.url }}"
                  data-section-id="{{ section_id }}"
                  data-product-id="{{ card_product.id }}"
                ></bulk-modal>
              </div>
            </div>
          </div>
        </modal-dialog>
      </div>
    {% endif %}
  {% endif %}
</div>
