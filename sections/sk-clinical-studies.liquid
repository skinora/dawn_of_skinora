{% comment %}
  SK Clinical Studies
  - Simple, accessible list of study/reference blocks (no accordion)
  - Uses theme tokens (no hardcoded colors)
  - Optional JSON-LD ItemList
{% endcomment %}

<section class="sk-studies" data-section-id="{{ section.id }}">
  <div class="page-width">
    {% if section.settings.eyebrow != blank
      or section.settings.heading != blank
      or section.settings.intro != blank
      or section.settings.last_updated != blank
    %}
      <header class="sk-studies__header">
        {% if section.settings.eyebrow != blank %}
          <p class="sk-studies__eyebrow">{{ section.settings.eyebrow | escape }}</p>
        {% endif %}

        {% if section.settings.heading != blank %}
          <h2 class="sk-studies__heading">{{ section.settings.heading | escape }}</h2>
        {% endif %}

        {% if section.settings.last_updated != blank %}
          <p class="sk-studies__updated">{{ section.settings.last_updated | escape }}</p>
        {% endif %}

        {% if section.settings.intro != blank %}
          <div class="sk-studies__intro rte">
            {{ section.settings.intro }}
          </div>
        {% endif %}
      </header>
    {% endif %}

    {%- comment -%} Optional informational chips (not interactive) {%- endcomment -%}
    {% assign badges_joined = '' %}
    {% if section.settings.enable_filter and section.settings.show_badges %}
      {% for block in section.blocks %}
        {% if block.type == 'study' %}
          {% assign badge_value = block.settings.badge | strip %}
          {% if badge_value != blank %}
            {% capture badges_joined %}{{ badges_joined }}||{{ badge_value }}{% endcapture %}
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {% assign badge_list = badges_joined | split: '||' | uniq %}
    {% assign has_badges = false %}
    {% for b in badge_list %}
      {% assign b_stripped = b | strip %}
      {% if b_stripped != blank %}
        {% assign has_badges = true %}
        {% break %}
      {% endif %}
    {% endfor %}

    {% if section.settings.enable_filter and has_badges %}
      <div class="sk-studies__chips" aria-label="Study categories">
        {% for b in badge_list %}
          {% assign badge_label = b | strip %}
          {% if badge_label != blank %}
            <span class="sk-studies__chip">{{ badge_label | escape }}</span>
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}

    {% assign list_style_class = '' %}
    {% if section.settings.list_style == 'plain' %}
      {% assign list_style_class = ' sk-studies__list--plain' %}
    {% endif %}

    <ol class="sk-studies__list{{ list_style_class }}">
      {% for block in section.blocks %}
        {% if block.type == 'study' %}
          {% assign title = block.settings.title | strip %}
          {% if title != blank %}
            {% assign badge_value = block.settings.badge | strip %}
            {% assign year_value = block.settings.year %}

            <li class="sk-study" {{ block.shopify_attributes }}>
              <div class="sk-study__card">
                <div class="sk-study__meta">
                  {% if section.settings.show_badges and badge_value != blank %}
                    <span class="sk-study__badge">{{ badge_value | escape }}</span>
                  {% endif %}

                  {% if section.settings.show_year and year_value != blank %}
                    <span class="sk-study__year" aria-label="År">{{ year_value }}</span>
                  {% endif %}
                </div>

                <h3 class="sk-study__title">{{ title | escape }}</h3>

                {% if block.settings.source != blank %}
                  <p class="sk-study__source">{{ block.settings.source | escape }}</p>
                {% endif %}

                {% if block.settings.summary != blank %}
                  <div class="sk-study__summary rte">
                    {{ block.settings.summary }}
                  </div>
                {% endif %}

                {% assign has_links = false %}
                {% if block.settings.primary_url != blank %}{% assign has_links = true %}{% endif %}
                {% if block.settings.secondary_url != blank %}{% assign has_links = true %}{% endif %}
                {% if block.settings.doi_url != blank %}{% assign has_links = true %}{% endif %}

                {% if has_links %}
                  <div class="sk-study__links" aria-label="Links">
                    {% if block.settings.primary_url != blank %}
                      <a
                        class="sk-study__link sk-study__link--primary"
                        href="{{ block.settings.primary_url }}"
                        target="_blank"
                        rel="nofollow noopener"
                      >
                        {{ block.settings.primary_label | default: 'Les mer' | escape }}
                      </a>
                    {% endif %}

                    {% if block.settings.secondary_url != blank %}
                      <a
                        class="sk-study__link"
                        href="{{ block.settings.secondary_url }}"
                        target="_blank"
                        rel="nofollow noopener"
                      >
                        {{ block.settings.secondary_label | default: 'Kilde' | escape }}
                      </a>
                    {% endif %}

                    {% if block.settings.doi_url != blank %}
                      <a
                        class="sk-study__link"
                        href="{{ block.settings.doi_url }}"
                        target="_blank"
                        rel="nofollow noopener"
                        aria-label="Open DOI"
                      >
                        {{ block.settings.doi_text | default: 'DOI' | escape }}
                      </a>
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            </li>
          {% endif %}
        {% endif %}
      {% endfor %}
    </ol>
  </div>

  <style>
    #shopify-section-{{ section.id }} .sk-studies{
      /* Rhythm + typography tokens (no hardcoded fonts/colors) */
      --sk-max: 82ch;

      --sk-1: 6px;
      --sk-2: 12px;
      --sk-3: 18px;
      --sk-4: 24px;
      --sk-5: 30px;
      --sk-6: 36px;
      --sk-8: 48px;
      --sk-10: 60px;

      --sk-border: 0.1rem solid rgba(var(--color-foreground), 0.18);
      --sk-soft: rgba(var(--color-foreground), 0.035);
      --sk-soft-2: rgba(var(--color-foreground), 0.055);

      background: rgb(var(--color-background));
      color: rgb(var(--color-foreground));
      padding-block: clamp(var(--sk-8), 5vw, var(--sk-10));
      overflow-x: clip;
    }

    @supports not (overflow: clip) {
      #shopify-section-{{ section.id }} .sk-studies{ overflow-x: hidden; }
    }

    #shopify-section-{{ section.id }} .sk-studies *{ box-sizing: border-box; }

    /* Header */
    #shopify-section-{{ section.id }} .sk-studies__header{
      max-width: var(--sk-max);
      margin: 0 auto var(--sk-8);
      text-align: center;
    }

    #shopify-section-{{ section.id }} .sk-studies__eyebrow{
      margin: 0 0 var(--sk-2);
      font-family: var(--font-heading-family);
      font-style: var(--font-heading-style);
      font-weight: var(--font-heading-weight);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 0.85rem;
      color: rgba(var(--color-foreground), 0.7);
    }

    #shopify-section-{{ section.id }} .sk-studies__heading{
      margin: 0;
      font-family: var(--font-heading-family);
      font-style: var(--font-heading-style);
      font-weight: var(--font-heading-weight);
      font-size: clamp(1.8rem, 2.6vw, 2.4rem);
      line-height: 1.15;
      letter-spacing: -0.01em;
    }

    #shopify-section-{{ section.id }} .sk-studies__updated{
      margin: var(--sk-2) 0 0;
      color: rgba(var(--color-foreground), 0.7);
      font-size: 0.95rem;
    }

    #shopify-section-{{ section.id }} .sk-studies__intro{
      margin-top: var(--sk-4);
      max-width: var(--sk-max);
      margin-inline: auto;
      color: rgba(var(--color-foreground), 0.85);
      line-height: 1.7;
    }

    /* Optional chips: make them feel “documentation tags” */
    #shopify-section-{{ section.id }} .sk-studies__chips{
      display: flex;
      flex-wrap: wrap;
      gap: var(--sk-2);
      justify-content: center;
      max-width: var(--sk-max);
      margin: 0 auto var(--sk-8);
    }

    #shopify-section-{{ section.id }} .sk-studies__chip{
      display: inline-flex;
      align-items: center;
      padding: 8px 12px;
      border: var(--sk-border);
      border-radius: var(--buttons-radius);
      background: var(--sk-soft);
      color: rgba(var(--color-foreground), 0.88);
      font-size: 0.95rem;
      line-height: 1;
      white-space: nowrap;
    }

    /* LIST: convert OL into a “numbered documentation list” with a number gutter */
    #shopify-section-{{ section.id }} .sk-studies__list{
      max-width: var(--sk-max);
      margin: 0 auto;
      padding: 0;
      list-style: none;               /* we’ll render our own numbers */
      counter-reset: skstudy;
      display: flex;
      flex-direction: column;
      gap: var(--sk-4);
    }

    #shopify-section-{{ section.id }} .sk-study{
      counter-increment: skstudy;
      display: grid;
      grid-template-columns: 44px 1fr;
      gap: var(--sk-3);
      align-items: start;
    }

    /* Number column */
    #shopify-section-{{ section.id }} .sk-study::before{
      content: counter(skstudy) ".";
      display: block;
      padding-top: 10px;
      font-family: var(--font-heading-family);
      font-style: var(--font-heading-style);
      font-weight: var(--font-heading-weight);
      color: rgba(var(--color-foreground), 0.55);
      font-size: 1rem;
      text-align: right;
    }

    /* Card */
    #shopify-section-{{ section.id }} .sk-study__card{
      border: var(--sk-border);
      border-radius: var(--text-boxes-radius);
      background: var(--sk-soft);
      padding: clamp(var(--sk-3), 2.2vw, var(--sk-5));
      box-shadow: 0 1px 0 rgba(var(--color-foreground), 0.04);
    }

    /* Meta row */
    #shopify-section-{{ section.id }} .sk-study__meta{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--sk-2);
      margin-bottom: var(--sk-2);
    }

    /* Badge pill */
    #shopify-section-{{ section.id }} .sk-study__badge{
      display: inline-flex;
      align-items: center;
      padding: 8px 12px;
      border-radius: var(--buttons-radius);
      border: 0.1rem solid rgba(var(--color-foreground), 0.22);
      background: var(--sk-soft-2);
      font-size: 0.95rem;
      line-height: 1;
      color: rgba(var(--color-foreground), 0.9);
      max-width: 100%;
    }

    /* Year */
    #shopify-section-{{ section.id }} .sk-study__year{
      font-size: 0.95rem;
      color: rgba(var(--color-foreground), 0.68);
      white-space: nowrap;
    }

    /* Title */
    #shopify-section-{{ section.id }} .sk-study__title{
      margin: 0;
      font-family: var(--font-heading-family);
      font-style: var(--font-heading-style);
      font-weight: var(--font-heading-weight);
      font-size: clamp(1.15rem, 1.6vw, 1.35rem);
      line-height: 1.25;
      letter-spacing: -0.01em;
    }

    /* Source */
    #shopify-section-{{ section.id }} .sk-study__source{
      margin: var(--sk-2) 0 0;
      color: rgba(var(--color-foreground), 0.72);
      font-size: 0.98rem;
      overflow-wrap: anywhere;
    }

    /* Summary */
    #shopify-section-{{ section.id }} .sk-study__summary{
      margin-top: var(--sk-3);
      color: rgba(var(--color-foreground), 0.9);
      line-height: 1.7;
    }

    /* Links as “documentation buttons” */
    #shopify-section-{{ section.id }} .sk-study__links{
      margin-top: var(--sk-4);
      display: flex;
      flex-wrap: wrap;
      gap: var(--sk-2);
    }

    #shopify-section-{{ section.id }} .sk-study__link{
      display: inline-flex;
      align-items: center;
      padding: 10px 14px;
      border-radius: var(--buttons-radius);
      border: 0.1rem solid rgba(var(--color-foreground), 0.22);
      background: rgba(var(--color-foreground), 0.02);
      color: var(--color-brand);
      text-decoration: none;
      font-size: 0.98rem;
      line-height: 1;
      max-width: 100%;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    #shopify-section-{{ section.id }} .sk-study__link--primary{
      border-color: rgba(var(--color-foreground), 0.28);
      background: rgba(var(--color-foreground), 0.04);
      font-weight: 600;
    }

    #shopify-section-{{ section.id }} .sk-study__link:hover{
      text-decoration: underline;
      text-underline-offset: 0.22em;
    }

    #shopify-section-{{ section.id }} .sk-study__link:focus-visible{
      outline: var(--focused-base-outline);
      outline-offset: 2px;
    }

    /* Mobile */
    @media (max-width: 749px){
      #shopify-section-{{ section.id }} .sk-study{
        grid-template-columns: 32px 1fr;
        gap: var(--sk-2);
      }
      #shopify-section-{{ section.id }} .sk-study::before{
        padding-top: 12px;
        font-size: 0.95rem;
      }
    }
  </style>

  {% if section.settings.show_jsonld %}
    {% assign position = 0 %}
    {% capture itemlist_json %}{% endcapture %}

    {% for block in section.blocks %}
      {% if block.type == 'study' %}
        {% assign title = block.settings.title | strip %}
        {% if title != blank %}
          {% assign position = position | plus: 1 %}

          {% assign item_url = '' %}
          {% if block.settings.primary_url != blank %}
            {% assign item_url = block.settings.primary_url %}
          {% elsif block.settings.doi_url != blank %}
            {% assign item_url = block.settings.doi_url %}
          {% elsif block.settings.secondary_url != blank %}
            {% assign item_url = block.settings.secondary_url %}
          {% endif %}

          {% capture list_item %}
            {
              "@type": "ListItem",
              "position": {{ position }},
              "name": {{ title | json }}{% if item_url != blank %},
              "url": {{ item_url | json }}{% endif %}
            }
          {% endcapture %}

          {% if position > 1 %}
            {% capture itemlist_json %}{{ itemlist_json }},{{ list_item }}{% endcapture %}
          {% else %}
            {% capture itemlist_json %}{{ list_item }}{% endcapture %}
          {% endif %}
        {% endif %}
      {% endif %}
    {% endfor %}

    {% if position > 0 %}
      <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "ItemList",
          "itemListElement": [{{ itemlist_json }}]
        }
      </script>
    {% endif %}
  {% endif %}
</section>

{% schema %}
{
  "name": "SK Clinical Studies",
  "settings": [
    {
      "type": "text",
      "id": "eyebrow",
      "label": "Eyebrow"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Clinical studies"
    },
    {
      "type": "text",
      "id": "last_updated",
      "label": "Last updated"
    },
    {
      "type": "richtext",
      "id": "intro",
      "label": "Intro"
    },
    {
      "type": "select",
      "id": "list_style",
      "label": "List style",
      "default": "numbered",
      "options": [
        { "value": "numbered", "label": "Numbered" },
        { "value": "plain", "label": "Plain" }
      ]
    },
    {
      "type": "checkbox",
      "id": "show_year",
      "label": "Show year",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_badges",
      "label": "Show badges",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_filter",
      "label": "Show category chips (informational)",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_jsonld",
      "label": "Output JSON-LD (ItemList)",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "study",
      "name": "Study",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Study title"
        },
        {
          "type": "text",
          "id": "badge",
          "label": "Badge/tag"
        },
        {
          "type": "number",
          "id": "year",
          "label": "Year"
        },
        {
          "type": "text",
          "id": "source",
          "label": "Source / journal"
        },
        {
          "type": "richtext",
          "id": "summary",
          "label": "Summary"
        },
        {
          "type": "text",
          "id": "primary_label",
          "label": "Primary link label",
          "default": "Les mer"
        },
        {
          "type": "url",
          "id": "primary_url",
          "label": "Primary link URL"
        },
        {
          "type": "text",
          "id": "secondary_label",
          "label": "Secondary link label",
          "default": "Kilde"
        },
        {
          "type": "url",
          "id": "secondary_url",
          "label": "Secondary link URL"
        },
        {
          "type": "text",
          "id": "doi_text",
          "label": "DOI text"
        },
        {
          "type": "url",
          "id": "doi_url",
          "label": "DOI URL"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "SK Clinical Studies"
    }
  ]
}
{% endschema %}
