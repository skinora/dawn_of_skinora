{% comment %}
  SK Clinical Studies
  - Simple, accessible list of study/reference blocks (no accordion)
  - Uses theme tokens (no hardcoded colors)
  - Optional JSON-LD ItemList
{% endcomment %}

<section class="sk-studies" data-section-id="{{ section.id }}">
  <div class="page-width">
    {% if section.settings.eyebrow != blank
      or section.settings.heading != blank
      or section.settings.intro != blank
      or section.settings.last_updated != blank
    %}
      <div class="sk-section-header sk-section-header--center">
        {% if section.settings.eyebrow != blank %}
          <p class="sk-section-header__eyebrow">{{ section.settings.eyebrow | escape }}</p>
        {% endif %}

        {% if section.settings.heading != blank %}
          <h2 class="sk-section-header__title">{{ section.settings.heading | escape }}</h2>
        {% endif %}

        {% if section.settings.last_updated != blank %}
          <p class="sk-section-header__subtitle">{{ section.settings.last_updated | escape }}</p>
        {% endif %}

        {% if section.settings.intro != blank %}
          <div class="sk-section-header__subtitle rte">
            {{ section.settings.intro }}
          </div>
        {% endif %}
      </div>
    {% endif %}

    {%- comment -%} Optional informational chips (not interactive) {%- endcomment -%}
    {% assign badges_joined = '' %}
    {% if section.settings.enable_filter and section.settings.show_badges %}
      {% for block in section.blocks %}
        {% if block.type == 'study' %}
          {% assign badge_value = block.settings.badge | strip %}
          {% if badge_value != blank %}
            {% capture badges_joined %}{{ badges_joined }}||{{ badge_value }}{% endcapture %}
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {% assign badge_list = badges_joined | split: '||' | uniq %}
    {% assign has_badges = false %}
    {% for b in badge_list %}
      {% assign b_stripped = b | strip %}
      {% if b_stripped != blank %}
        {% assign has_badges = true %}
        {% break %}
      {% endif %}
    {% endfor %}

    {% if section.settings.enable_filter and has_badges %}
      {%- comment -%}
        Chips moved into sidebar layout below (see .sk-studies__layout)
      {%- endcomment -%}
    {% endif %}

    {% assign list_style_class = '' %}
    {% if section.settings.list_style == 'plain' %}
      {% assign list_style_class = ' sk-studies__list--plain' %}
    {% endif %}

    <div class="sk-studies__layout">
      {% if section.settings.enable_filter and has_badges %}
        <aside class="sk-studies__sidebar" aria-label="Kategorier">
          <h3 class="sk-studies__side-title">Kategorier</h3>
          <div class="sk-studies__chips">
            {% for b in badge_list %}
              {% assign badge_label = b | strip %}
              {% if badge_label != blank %}
                <span class="sk-studies__chip">{{ badge_label | escape }}</span>
              {% endif %}
            {% endfor %}
          </div>
          <p class="sk-studies__side-note">Tips: bruk korte tagger. Lange tagger bør splittes i flere chips.</p>
        </aside>
      {% endif %}

      <div class="sk-studies__main">
        <ol class="sk-studies__list{{ list_style_class }}">
          {% for block in section.blocks %}
            {% if block.type == 'study' %}
              {% assign title = block.settings.title | strip %}
              {% if title != blank %}
                {% assign badge_value = block.settings.badge | strip %}
                {% assign year_value = block.settings.year %}

                <li class="sk-study" {{ block.shopify_attributes }}>
                  <div class="sk-study__card">
                    <div class="sk-study__meta">
                      {% if section.settings.show_badges and badge_value != blank %}
                        {% assign badge_items = badge_value | replace: '|', '·' | split: '·' %}
                        <div class="sk-study__badges" aria-label="Tags">
                          {% for item in badge_items %}
                            {% assign tag = item | strip %}
                            {% if tag != blank %}
                              <span class="sk-study__badge">{{ tag | escape }}</span>
                            {% endif %}
                          {% endfor %}
                        </div>
                      {% endif %}

                      {% if section.settings.show_year and year_value != blank %}
                        <span class="sk-study__year" aria-label="År">{{ year_value }}</span>
                      {% endif %}
                    </div>

                    <h3 class="sk-study__title">{{ title | escape }}</h3>

                    {% if block.settings.source != blank %}
                      <p class="sk-study__source">{{ block.settings.source | escape }}</p>
                    {% endif %}

                    {% if block.settings.summary != blank %}
                      <div class="sk-study__summary rte">
                        {{ block.settings.summary }}
                      </div>
                    {% endif %}

                    {% assign has_links = false %}
                    {% if block.settings.primary_url != blank %}{% assign has_links = true %}{% endif %}
                    {% if block.settings.secondary_url != blank %}{% assign has_links = true %}{% endif %}
                    {% if block.settings.doi_url != blank %}{% assign has_links = true %}{% endif %}

                    {% if has_links %}
                      <div class="sk-study__links" aria-label="Links">
                        {% if block.settings.primary_url != blank %}
                          <a
                            class="sk-study__link sk-study__link--primary"
                            href="{{ block.settings.primary_url }}"
                            target="_blank"
                            rel="nofollow noopener"
                          >
                            {{ block.settings.primary_label | default: 'Les mer' | escape }}
                          </a>
                        {% endif %}

                        {% if block.settings.secondary_url != blank %}
                          <a
                            class="sk-study__link"
                            href="{{ block.settings.secondary_url }}"
                            target="_blank"
                            rel="nofollow noopener"
                          >
                            {{ block.settings.secondary_label | default: 'Kilde' | escape }}
                          </a>
                        {% endif %}

                        {% if block.settings.doi_url != blank %}
                          <a
                            class="sk-study__link"
                            href="{{ block.settings.doi_url }}"
                            target="_blank"
                            rel="nofollow noopener"
                            aria-label="Open DOI"
                          >
                            {{ block.settings.doi_text | default: 'DOI' | escape }}
                          </a>
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                </li>
              {% endif %}
            {% endif %}
          {% endfor %}
        </ol>
      </div>
    </div>
  </div>

  <style>
    #shopify-section-{{ section.id }} .sk-studies{
      --sk-max: 92ch;

      --sk-1: 6px;
      --sk-2: 12px;
      --sk-3: 18px;
      --sk-4: 24px;
      --sk-5: 30px;
      --sk-6: 36px;
      --sk-8: 48px;

      --sk-border: 0.1rem solid rgba(var(--color-foreground), 0.16);
      --sk-soft: rgba(var(--color-foreground), 0.028);
      --sk-soft-2: rgba(var(--color-foreground), 0.05);

      --sk-accent-rgb: var(--color-brand-rgb, var(--color-foreground));
      --sk-accent-ink: rgb(var(--sk-accent-rgb));
      --sk-accent-line: rgba(var(--sk-accent-rgb), 0.34);
      --sk-accent-border: rgba(var(--sk-accent-rgb), 0.46);
      --sk-focus: 0 0 0 0.24rem rgba(var(--sk-accent-rgb), 0.28);

      --sk-accent: var(--sk-accent-ink);

      background: rgb(var(--color-white-rgb, 255, 255, 255));
      color: rgb(var(--color-foreground));
      padding-block: clamp(var(--sk-6), 4vw, var(--sk-8));
    }

    #shopify-section-{{ section.id }} .sk-section-header{
      max-width: var(--sk-max);
      margin: 0 auto var(--sk-6);
    }

    #shopify-section-{{ section.id }} .sk-section-header__title{
      position: relative;
    }

    #shopify-section-{{ section.id }} .sk-section-header__title::after{
      content: "";
      display: block;
      width: min(180px, 42vw);
      height: 0.2rem;
      margin: var(--sk-3) auto 0;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(var(--sk-accent-rgb), 0) 0%, rgba(var(--sk-accent-rgb), 0.48) 18%, rgba(var(--sk-accent-rgb), 0.48) 82%, rgba(var(--sk-accent-rgb), 0) 100%);
    }

    /* Layout */
    #shopify-section-{{ section.id }} .sk-studies__layout{
      max-width: var(--sk-max);
      margin: 0 auto;
      display: grid;
      gap: var(--sk-4);
    }

    @media (min-width: 990px){
      #shopify-section-{{ section.id }} .sk-studies__layout{
        grid-template-columns: minmax(240px, 0.34fr) minmax(0, 1fr);
        align-items: start;
      }
      #shopify-section-{{ section.id }} .sk-studies__sidebar{
        position: sticky;
        top: 18px;
      }
    }

    /* Sidebar */
    #shopify-section-{{ section.id }} .sk-studies__sidebar{
      border: var(--sk-border);
      border-left: 0.3rem solid var(--sk-accent-line);
      border-radius: var(--text-boxes-radius);
      background: var(--sk-soft);
      padding: var(--sk-4);
    }

    #shopify-section-{{ section.id }} .sk-studies__side-title{
      margin: 0 0 var(--sk-2);
      font-family: var(--font-heading-family);
      font-style: var(--font-heading-style);
      font-weight: var(--font-heading-weight);
      font-size: 1.05rem;
    }

    #shopify-section-{{ section.id }} .sk-studies__side-note{
      margin: var(--sk-3) 0 0;
      color: rgba(var(--color-foreground), .65);
      font-size: .92rem;
      line-height: 1.55;
    }

    /* Chips */
    #shopify-section-{{ section.id }} .sk-studies__chips{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 0;
    }

    #shopify-section-{{ section.id }} .sk-studies__chip{
      display: inline-flex;
      align-items: center;
      padding: 8px 12px;
      border: 0.1rem solid var(--sk-accent-line);
      border-radius: 999px;
      background: rgba(var(--color-foreground), 0.02);
      font-size: .95rem;
      color: rgba(var(--color-foreground), .90);
    }

    /* List */
    #shopify-section-{{ section.id }} .sk-studies__list{
      margin: 0;
      padding: 0;
      list-style: none;
      counter-reset: skstudy;
      display: flex;
      flex-direction: column;
      gap: var(--sk-3);
    }

    #shopify-section-{{ section.id }} .sk-study{
      counter-increment: skstudy;
      display: grid;
      grid-template-columns: 42px 1fr;
      gap: var(--sk-3);
      align-items: start;
    }

    #shopify-section-{{ section.id }} .sk-study::before{
      content: counter(skstudy) ".";
      display: block;
      padding-top: 14px;
      text-align: right;
      font-family: var(--font-heading-family);
      font-style: var(--font-heading-style);
      font-weight: var(--font-heading-weight);
      color: rgba(var(--sk-accent-rgb), .62);
    }

    /* Plain mode */
    #shopify-section-{{ section.id }} .sk-studies__list--plain .sk-study{
      grid-template-columns: 1fr;
    }
    #shopify-section-{{ section.id }} .sk-studies__list--plain .sk-study::before{
      content: none;
      display: none;
    }

    /* Card */
    #shopify-section-{{ section.id }} .sk-study__card{
      border: 0.1rem solid var(--sk-accent-border);
      border-radius: calc(var(--text-boxes-radius) + 6px);
      background: rgb(var(--color-white-rgb, 255, 255, 255));
      padding: clamp(var(--sk-3), 2vw, var(--sk-4));
    }

    #shopify-section-{{ section.id }} .sk-study__meta{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--sk-2);
      margin-bottom: var(--sk-2);
    }

    #shopify-section-{{ section.id }} .sk-study__badges{
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-width: 0;
    }

    #shopify-section-{{ section.id }} .sk-study__badge{
      display: inline-flex;
      align-items: center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 0.1rem solid var(--sk-accent-line);
      background: rgba(var(--sk-accent-rgb), 0.08);
      font-size: .92rem;
      line-height: 1;
      color: rgba(var(--color-foreground), .9);
    }

    #shopify-section-{{ section.id }} .sk-study__year{
      font-size: .92rem;
      color: rgba(var(--color-foreground), .65);
      white-space: nowrap;
    }

    #shopify-section-{{ section.id }} .sk-study__title{
      margin: 0;
      font-family: var(--font-heading-family);
      font-style: var(--font-heading-style);
      font-weight: var(--font-heading-weight);
      font-size: clamp(1.6rem, 2.2vw, 2.1rem);
      line-height: 1.25;
    }

    #shopify-section-{{ section.id }} .sk-study__source{
      margin: 10px 0 0;
      color: rgba(var(--color-foreground), .68);
      font-size: .95rem;
    }

    #shopify-section-{{ section.id }} .sk-study__summary{
      margin-top: var(--sk-3);
      line-height: 1.65;
      color: rgba(var(--color-foreground), .9);
    }

    #shopify-section-{{ section.id }} .sk-study__summary.rte p{
      font-size: clamp(1.35rem, 1.6vw, 1.7rem);
    }

    /* Links */
    #shopify-section-{{ section.id }} .sk-study__links{
      margin-top: var(--sk-3);
      padding-top: var(--sk-3);
      border-top: 0.1rem solid rgba(var(--color-foreground), 0.10);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    #shopify-section-{{ section.id }} .sk-study__link{
      display: inline-flex;
      align-items: center;
      padding: 10px 14px;
      border-radius: calc(var(--buttons-radius) + 6px);
      border: 0.1rem solid var(--sk-accent-border);
      background: rgb(var(--color-white-rgb, 255, 255, 255));
      color: var(--sk-accent);
      text-decoration: none;
      font-size: clamp(1.15rem, 1.2vw, 1.4rem);
      line-height: 1;
    }

    #shopify-section-{{ section.id }} .sk-study__link--primary{
      font-weight: 600;
      border-color: rgba(var(--sk-accent-rgb), 0.60);
      box-shadow: 0 0 0 0.1rem rgba(var(--sk-accent-rgb), 0.12);
    }

    #shopify-section-{{ section.id }} .sk-study__link:hover{
      border-color: rgba(var(--sk-accent-rgb), 0.70);
      background: rgba(var(--color-foreground), 0.02);
      text-decoration: underline;
      text-underline-offset: .22em;
    }

    #shopify-section-{{ section.id }} .sk-study__link:focus-visible{
      outline: none;
      box-shadow: var(--sk-focus);
    }

    @media (max-width: 749px){
      #shopify-section-{{ section.id }} .sk-study{
        grid-template-columns: 28px 1fr;
        gap: var(--sk-2);
      }
    }
  </style>

  <script>
    (function initSkClinicalStudiesExternalLinks() {
      var root = document.querySelector('.sk-studies[data-section-id="{{ section.id }}"]');
      if (!root) return;

      var anchors = root.querySelectorAll('a[href]');
      if (!anchors || anchors.length === 0) return;

      anchors.forEach(function (a) {
        var href = a.getAttribute('href');
        if (!href) return;

        if (href.indexOf('http://') !== 0 && href.indexOf('https://') !== 0) return;

        var url;
        try {
          url = new URL(href, window.location.href);
        } catch (e) {
          return;
        }

        if (!url.hostname || url.hostname === window.location.hostname) return;

        a.setAttribute('target', '_blank');
        var existingRel = (a.getAttribute('rel') || '').toLowerCase();
        var relParts = existingRel ? existingRel.split(/\s+/) : [];
        ['noopener', 'nofollow'].forEach(function (token) {
          if (relParts.indexOf(token) === -1) relParts.push(token);
        });
        a.setAttribute('rel', relParts.join(' ').trim());
      });
    })();
  </script>

  {% if section.settings.show_jsonld %}
    {% assign position = 0 %}
    {% capture itemlist_json %}{% endcapture %}

    {% for block in section.blocks %}
      {% if block.type == 'study' %}
        {% assign title = block.settings.title | strip %}
        {% if title != blank %}
          {% assign position = position | plus: 1 %}

          {% assign item_url = '' %}
          {% if block.settings.primary_url != blank %}
            {% assign item_url = block.settings.primary_url %}
          {% elsif block.settings.doi_url != blank %}
            {% assign item_url = block.settings.doi_url %}
          {% elsif block.settings.secondary_url != blank %}
            {% assign item_url = block.settings.secondary_url %}
          {% endif %}

          {% capture list_item %}
            {
              "@type": "ListItem",
              "position": {{ position }},
              "name": {{ title | json }}{% if item_url != blank %},
              "url": {{ item_url | json }}{% endif %}
            }
          {% endcapture %}

          {% if position > 1 %}
            {% capture itemlist_json %}{{ itemlist_json }},{{ list_item }}{% endcapture %}
          {% else %}
            {% capture itemlist_json %}{{ list_item }}{% endcapture %}
          {% endif %}
        {% endif %}
      {% endif %}
    {% endfor %}

    {% if position > 0 %}
      <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "ItemList",
          "itemListElement": [{{ itemlist_json }}]
        }
      </script>
    {% endif %}
  {% endif %}
</section>

{% schema %}
{
  "name": "SK Clinical Studies",
  "settings": [
    {
      "type": "text",
      "id": "eyebrow",
      "label": "Eyebrow"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Clinical studies"
    },
    {
      "type": "text",
      "id": "last_updated",
      "label": "Last updated"
    },
    {
      "type": "richtext",
      "id": "intro",
      "label": "Intro"
    },
    {
      "type": "select",
      "id": "list_style",
      "label": "List style",
      "default": "numbered",
      "options": [
        { "value": "numbered", "label": "Numbered" },
        { "value": "plain", "label": "Plain" }
      ]
    },
    {
      "type": "checkbox",
      "id": "show_year",
      "label": "Show year",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_badges",
      "label": "Show badges",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_filter",
      "label": "Show category chips (informational)",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_jsonld",
      "label": "Output JSON-LD (ItemList)",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "study",
      "name": "Study",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Study title"
        },
        {
          "type": "text",
          "id": "badge",
          "label": "Badge/tag"
        },
        {
          "type": "number",
          "id": "year",
          "label": "Year"
        },
        {
          "type": "text",
          "id": "source",
          "label": "Source / journal"
        },
        {
          "type": "richtext",
          "id": "summary",
          "label": "Summary"
        },
        {
          "type": "text",
          "id": "primary_label",
          "label": "Primary link label",
          "default": "Les mer"
        },
        {
          "type": "url",
          "id": "primary_url",
          "label": "Primary link URL"
        },
        {
          "type": "text",
          "id": "secondary_label",
          "label": "Secondary link label",
          "default": "Kilde"
        },
        {
          "type": "url",
          "id": "secondary_url",
          "label": "Secondary link URL"
        },
        {
          "type": "text",
          "id": "doi_text",
          "label": "DOI text"
        },
        {
          "type": "url",
          "id": "doi_url",
          "label": "DOI URL"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "SK Clinical Studies"
    }
  ]
}
{% endschema %}
