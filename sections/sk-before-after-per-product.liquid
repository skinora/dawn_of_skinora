{% comment %}
  SK Before/After Section
  Single-image before/after look (visual split only)
{% endcomment %}

<style>
  .sk-before-after {
    padding: 0 0 5rem;
    background-color: var(--color-white);
    position: relative;
    overflow: visible;
  }

  .swiper-slide {
    display: flex;
    justify-content: center;
  }

  .sk-testimonial-card {
    width: 100%;
    background: #fff;
    border-radius: 0;
    overflow: hidden;
    --sk-ba-image-base-height: clamp(260px, 30vw, 360px);
  }

  /* === SINGLE IMAGE WITH FAKE BEFORE / AFTER SPLIT === */

  .sk-testimonial-card__images {
    position: relative;
    height: calc(var(--sk-ba-image-base-height) * 1.15);
    overflow: hidden;
  }

  .sk-testimonial-card__images img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  /* vertical divider */
  /* pills */
  .sk-ba-pill {
    position: absolute;
    top: 1.2rem;
    padding: 0.6rem 1.4rem;
    font-size: clamp(1.2rem, 1.5vw, 1.3rem);
    background: rgba(245, 245, 245, 0.95);
    border-radius: 0;
    font-weight: 500;
    color: var(--color-neutral-3);
    z-index: 3;
  }

  .sk-ba-pill--before {
    left: 1.2rem;
  }
  .sk-ba-pill--after {
    right: 1.2rem;
  }

  /* === CONTENT === */

  .sk-testimonial-card__content {
    padding: clamp(1.6rem, 2vw, 1.8rem) clamp(1.8rem, 2.5vw, 2rem) clamp(1rem, 1.25vw, 1.1rem);
    text-align: left;
  }

  .sk-testimonial-card__title {
    font-size: clamp(1.6rem, 2vw, 1.8rem);
    font-weight: 600;
    margin-bottom: 0.6rem;
    color: var(--color-black);
  }

  .sk-testimonial-card__meta {
    font-size: clamp(1.3rem, 1.8vw, 1.4rem);
    color: var(--color-neutral-2);
    margin-bottom: 1.2rem;
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }

  .sk-testimonial-card__text {
    font-size: clamp(1.4rem, 1.8vw, 1.5rem);
    line-height: 1.5;
    color: var(--color-neutral-3);
  }

  .sk-before-after .sk-radiance-product__media-progress {
    display: flex;
    justify-content: center;
    margin-top: 0.75rem;
  }

  .sk-before-after .sk-radiance-product__media-progress-squares {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
  }

  .sk-before-after .sk-radiance-product__media-progress-square {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--color-border);
    transition: background 0.2s ease, transform 0.2s ease;
    border: none;
    padding: 0;
    cursor: pointer;
  }

  .sk-before-after .sk-radiance-product__media-progress-square--active {
    background: var(--color-brand);
    transform: scale(1.25);
  }

  .sk-before-after-viewport {
    position: relative;
    overflow: hidden;
    width: 100%;
  }

  @media (max-width: 899px) {
    .sk-before-after .sk-before-after-prev,
    .sk-before-after .sk-before-after-next {
      display: none;
    }
    .sk-before-after .swiper-button-prev,
    .sk-before-after .swiper-button-next {
      display: none;
    }
    .sk-before-after .sk-before-after-prev.sk-arrow-visible,
    .sk-before-after .sk-before-after-next.sk-arrow-visible,
    .sk-before-after .swiper-button-prev.sk-arrow-visible,
    .sk-before-after .swiper-button-next.sk-arrow-visible {
      display: flex !important;
      opacity: 1 !important;
      pointer-events: auto !important;
    }
  }

  @media (min-width: 900px) {
    .sk-before-after-viewport {
      overflow: visible;
    }

    .sk-before-after .sk-before-after-swiper {
      overflow: hidden !important;
    }

    .sk-before-after .sk-radiance-product__media-progress {
      display: none !important;
    }

    .sk-before-after .sk-before-after-prev::after,
    .sk-before-after .sk-before-after-next::after {
      content: '';
      position: absolute;
      width: 12px;
      height: 12px;
      border-top: 2px solid var(--color-brand);
      border-right: 2px solid var(--color-brand);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      transition: border-color 0.25s ease;
    }

    .sk-before-after .sk-before-after-prev::after {
      transform: translate(-50%, -50%) rotate(-135deg);
    }

    .sk-before-after .sk-before-after-next::after {
      transform: translate(-50%, -50%) rotate(45deg);
    }

    .sk-before-after .sk-before-after-prev,
    .sk-before-after .sk-before-after-next {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid var(--color-border);
      background: var(--color-white);
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.08);
      color: var(--color-dark);
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }

    .sk-before-after .sk-before-after-prev.sk-arrow-visible,
    .sk-before-after .sk-before-after-next.sk-arrow-visible {
      opacity: 1;
      pointer-events: auto;
    }

    .sk-before-after .sk-before-after-prev {
      left: clamp(12px, 2vw, 24px);
    }

    .sk-before-after .sk-before-after-next {
      right: clamp(12px, 2vw, 24px);
    }
  }

  .sk-before-after .swiper-button-disabled {
    opacity: 0 !important;
    pointer-events: none !important;
  }

  .sk-before-after .sk-arrow-visible.swiper-button-disabled {
    opacity: 1 !important;
    pointer-events: auto !important;
  }

  /* Swiper arrows & pagination untouched */
</style>

<section class="sk-before-after" data-section-id="{{ section.id }}">
  <div class="page-width">
    {% if section.settings.section_title != blank %}
      <div class="sk-section-header sk-section-header--center">
        <h1 class="sk-section-header__title">
          {{ section.settings.section_title }}
        </h1>
        {% if section.settings.section_subtitle != blank %}
          <p class="sk-section-header__subtitle">
            {{ section.settings.section_subtitle }}
          </p>
        {% endif %}
      </div>
    {% endif %}

    <div class="sk-before-after-viewport">
      <div class="swiper sk-before-after-swiper">
        <div class="swiper-wrapper">
          {% for item in product.metafields.custom.before_after_testimonial_product.value %}
            {% liquid
              assign image_value = item.image.value | default: item.image
              assign testimonial_alt_text = item.alt_text.value | default: item.alt_text
              assign testimonial_title = item.title.value | default: item.title
              assign testimonial_meta = item.meta.value | default: item.meta
              assign testimonial_quote = item.quote.value | default: item.quote
              assign display_alt = testimonial_alt_text | default: testimonial_title | default: 'Før og etter – Skinora Clear'

              assign img_src = null
              assign img_w = 800
              assign img_h = 360

              if image_value != blank
                if image_value.preview_image
                  assign img_obj = image_value.preview_image
                  assign img_src = img_obj | image_url: width: 800
                  assign img_w = img_obj.width | default: 800
                  assign img_h = img_obj.height | default: 360
                elsif image_value.width
                  assign img_obj = image_value
                  assign img_src = img_obj | image_url: width: 800
                  assign img_w = img_obj.width | default: 800
                  assign img_h = img_obj.height | default: 360
                else
                  assign img_src = image_value | file_url
                endif
              endif
            %}
            <div class="swiper-slide">
              <div class="sk-testimonial-card">
                <div class="sk-testimonial-card__images">
                  {% if img_src %}
                    <img
                      src="{{ img_src }}"
                      alt="{{ display_alt | escape }}"
                      width="{{ img_w }}"
                      height="{{ img_h }}"
                      loading="lazy"
                    >
                  {% endif %}

                  <span class="sk-ba-pill sk-ba-pill--before">FØR</span>
                  <span class="sk-ba-pill sk-ba-pill--after">...OG ETTER</span>
                </div>

                <div class="sk-testimonial-card__content">
                  {% if testimonial_title != blank %}
                    <h3 class="sk-testimonial-card__title">
                      {{ testimonial_title }}
                    </h3>
                  {% endif %}

                  {% if testimonial_meta != blank %}
                    <div class="sk-testimonial-card__meta">
                      {{ testimonial_meta }}
                      <span>✔</span>
                    </div>
                  {% endif %}

                  {% if testimonial_quote != blank %}
                    <p class="sk-testimonial-card__text">"{{ testimonial_quote }}"</p>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
      <div class="swiper-button-prev sk-before-after-prev"></div>
      <div class="swiper-button-next sk-before-after-next"></div>
    </div>
    {% assign testimonials_count = product.metafields.custom.before_after_testimonial_product.value | size -%}
    {%- if testimonials_count > 0 %}
      <div class="sk-radiance-product__media-progress" role="status" aria-live="polite">
        <div class="sk-radiance-product__media-progress-squares" role="tablist" aria-label="Testimonials progress">
          {% for item in product.metafields.custom.before_after_testimonial_product.value %}
            <button
              type="button"
              class="sk-radiance-product__media-progress-square{% if forloop.first %} sk-radiance-product__media-progress-square--active{% endif %}"
              data-progress-index="{{ forloop.index0 }}"
              aria-label="Vis eksempel {{ forloop.index }}"
              {% if forloop.first %}
                aria-current="true"
              {% endif %}
            ></button>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    if (typeof Swiper === 'undefined') return;

    const wrapper = document.querySelector('.sk-before-after[data-section-id="{{ section.id }}"]');
    if (!wrapper) return;

    const swiperElement = wrapper.querySelector('.sk-before-after-swiper');
    if (!swiperElement) return;

    const swiperInstance = new Swiper(swiperElement, {
      slidesPerView: 1,
      spaceBetween: 20,
      navigation: {
        nextEl: wrapper.querySelector('.sk-before-after-next'),
        prevEl: wrapper.querySelector('.sk-before-after-prev'),
      },
      breakpoints: {
        700: { slidesPerView: 2 },
        1024: { slidesPerView: 3 },
      },
    });

    const progressBar = wrapper.querySelector('.sk-radiance-product__media-progress');
    const progressSquares = progressBar
      ? Array.from(progressBar.querySelectorAll('.sk-radiance-product__media-progress-square'))
      : [];
    const prevArrow = wrapper.querySelector('.sk-before-after-prev');
    const nextArrow = wrapper.querySelector('.sk-before-after-next');

    const updateProgress = (index) => {
      if (!progressBar) return;
      const hideProgress = progressSquares.length <= 1;
      progressBar.classList.toggle('sk-radiance-product__media-progress--hidden', hideProgress);
      progressBar.setAttribute('aria-hidden', hideProgress ? 'true' : 'false');
      progressSquares.forEach((square, idx) => {
        const isActive = idx === index;
        square.classList.toggle('sk-radiance-product__media-progress-square--active', isActive);
        if (isActive) {
          square.setAttribute('aria-current', 'true');
        } else {
          square.removeAttribute('aria-current');
        }
      });
    };

    progressSquares.forEach((square, idx) => {
      square.addEventListener('click', () => swiperInstance.slideTo(idx));
    });

    const updateDesktopArrows = () => {
      if (!prevArrow || !nextArrow) return;

      const showPrev = !swiperInstance.isBeginning;
      const showNext = !swiperInstance.isEnd;

      prevArrow.classList.toggle('sk-arrow-visible', showPrev);
      nextArrow.classList.toggle('sk-arrow-visible', showNext);
      prevArrow.classList.toggle('swiper-button-disabled', !showPrev);
      nextArrow.classList.toggle('swiper-button-disabled', !showNext);
    };

    swiperInstance.on('init', updateDesktopArrows);
    swiperInstance.on('slideChange', updateDesktopArrows);
    swiperInstance.on('slideChangeTransitionEnd', updateDesktopArrows);
    swiperInstance.on('breakpoint', updateDesktopArrows);
    swiperInstance.on('slideChangeTransitionStart', updateDesktopArrows);
    swiperInstance.on('sliderMove', updateDesktopArrows);

    swiperInstance.on('slideChange', () => {
      updateProgress(swiperInstance.activeIndex);
    });

    updateProgress(swiperInstance.activeIndex);
    updateDesktopArrows();
    window.addEventListener('resize', updateDesktopArrows);
  });
</script>

{% schema %}
{
  "name": "SK Before/After Product",
  "settings": [
    {
      "type": "text",
      "id": "section_title",
      "label": "Title",
      "default": "Real results"
    },
    {
      "type": "textarea",
      "id": "section_subtitle",
      "label": "Subtitle",
      "default": "See the amazing transformations our customers have achieved"
    }
  ],
  "presets": [
    {
      "name": "SK Before/After Product"
    }
  ]
}
{% endschema %}
