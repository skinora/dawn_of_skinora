{% comment %}
  SECTION: Skinora – Product Specifications (Metaobject-driven)

  Metaobject type handle: product_specification (MUST match Shopify exactly)
  Fields:
  - section_header (single line text)
  - subheader (single line text)
  - main_image (file/image)        <-- used as poster / fallback
  - image_alt (single line text)
  - tech_details_blocks (list of metaobjects: tech_details_block)
      - title (single line)
      - content (rich text)
      - icon (file/image)
  - tech_spec_detailed_description (rich text)

  3D: Product media (GLB) is rendered natively via Shopify media_tag (best UX).

  FIXES (stable):
  1) If odd number of cells, last cell spans full width on desktop.
  2) Any block with rich text content spans both columns on desktop.
{% endcomment %}

<style>
  /* ===== Base / Desktop ===== */
  .sk-specs-{{ section.id }}{
    background:#fff;
    padding:clamp(48px, 6vw, 64px) 0;
    margin:0;
  }

  .sk-specs-{{ section.id }} .sk-specs__wrap{
    display:grid;
    grid-template-columns:minmax(280px, 11fr) minmax(0, 9fr);
    gap:clamp(32px, 5vw, 56px);
    align-items:stretch;
  }

  /* Controlled media height on desktop */
  .sk-specs-{{ section.id }} .sk-specs__media{
    position:relative;
    border-radius:clamp(16px, 1.2vw, 20px);
    overflow:hidden;
    height:100%;
    min-height:clamp(416px, 62vh, 640px);
    background: rgba(0,0,0,.04);
  }

  /* Image fills media box */
  .sk-specs-{{ section.id }} .sk-specs__img{
    width:100%;
    height:100%;
    display:block;
    object-fit:cover;
    object-position:center;
  }

  /* Shopify native 3D model media should fill the media box */
  .sk-specs-{{ section.id }} .sk-specs__media .sk-specs__model-media,
  .sk-specs-{{ section.id }} .sk-specs__media .media,
  .sk-specs-{{ section.id }} .sk-specs__media model-viewer,
  .sk-specs-{{ section.id }} .sk-specs__media .shopify-model-viewer-ui{
    width:100%;
    height:100%;
    display:block;
  }

  /* 3D hint overlay */
  .sk-specs-{{ section.id }} .sk-specs__hint{
    position:absolute;
    left:clamp(12px, 1.5vw, 16px);
    bottom:clamp(12px, 1.5vw, 16px);
    z-index:3;
    display:inline-flex;
    align-items:center;
    gap:clamp(8px, 1vw, 12px);
    padding:clamp(8px, 1vw, 12px) clamp(8px, 1.6vw, 16px);
    border-radius:999px;
    background:rgba(255,255,255,.88);
    border:1px solid rgba(0,0,0,.10);
    box-shadow:0 8px 24px rgba(0,0,0,.12);
    font-family:var(--font-body-family);
    font-size:13px;
    line-height:1;
    color:rgba(var(--sk-color-heading-text),.92);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    user-select:none;
    pointer-events:none;
  }

  .sk-specs-{{ section.id }} .sk-specs__hint-dot{
    width:8px;
    height:8px;
    border-radius:999px;
    background:rgba(var(--sk-color-heading-text),.55);
  }

  .sk-specs-{{ section.id }} .sk-specs__hint.is-hidden{
    opacity:0;
    transform:translateY(8px);
    transition:opacity .25s ease, transform .25s ease;
  }

  .sk-specs-{{ section.id }} .sk-specs__h{
    margin:0 0 clamp(8px, 1vw, 12px) 0;
    font-family:var(--font-heading-family);
    font-weight:600;
    letter-spacing:.06em;
    text-transform:uppercase;
    font-size:clamp(22px,2.2vw,34px);
    line-height:1.15;
    color:rgb(var(--sk-color-heading-text));
  }

  .sk-specs-{{ section.id }} .sk-specs__sub{
    margin:0 0 clamp(16px, 2vw, 24px) 0;
    max-width:58ch;
    font-family:var(--font-body-family);
    font-size:16px;
    line-height:1.6;
    color:rgba(var(--sk-color-body-text),.9);
  }

  /* Card */
  .sk-specs-{{ section.id }} .sk-specs__card{
    background:rgba(0,0,0,.04);
    border:1px solid rgba(0,0,0,.10);
    border-radius:16px;
    overflow:hidden;
  }

  .sk-specs-{{ section.id }} .sk-specs__grid{
    display:grid;
    grid-template-columns:1fr 1fr;
  }

  .sk-specs-{{ section.id }} .sk-specs__cell{
    display:grid;
    grid-template-columns:28px 1fr;
    gap:clamp(12px, 1.6vw, 16px);
    padding:clamp(16px, 1.6vw, 20px) clamp(16px, 2vw, 24px);
    border-bottom:1px solid rgba(0,0,0,.10);
    align-items:start;
  }

  .sk-specs-{{ section.id }} .sk-specs__cell:nth-child(odd){
    border-right:1px solid rgba(0,0,0,.10);
  }

  /* FIX 1: if odd number of cells, make the last one full width on desktop */
  @media (min-width: 991px){
    .sk-specs-{{ section.id }} .sk-specs__grid .sk-specs__cell:last-child:nth-child(odd){
      grid-column: 1 / -1;
      border-right: none;
    }
  }

  @media (min-width: 991px){
    .sk-specs-{{ section.id }} .sk-specs__grid .sk-specs__cell--wide{
      grid-column: 1 / -1;
      border-right: none !important; /* kills the middle divider */
    }

    /* ensure nth-child(odd) divider doesn't reappear */
    .sk-specs-{{ section.id }} .sk-specs__grid .sk-specs__cell--wide:nth-child(odd){
      border-right: none !important;
    }
  }

  @media (min-width: 991px){
    .sk-specs-{{ section.id }} .sk-specs__cell--inline-list .sk-specs__desc ul{
      list-style:none;
      margin:0;
      padding:0;
    }
    .sk-specs-{{ section.id }} .sk-specs__cell--inline-list .sk-specs__desc li{
      display:inline;
      margin:0;
      padding:0;
    }
    .sk-specs-{{ section.id }} .sk-specs__cell--inline-list .sk-specs__desc li + li{
      margin-top:0;
    }
    .sk-specs-{{ section.id }} .sk-specs__cell--inline-list .sk-specs__desc li + li::before{
      content:" • ";
      color: var(--sk-brand);
      opacity:.75;
    }
  }

  .sk-specs-{{ section.id }} .sk-specs__icon{
    width:28px;
    height:28px;
    display:grid;
    place-items:center;
    color:rgba(var(--sk-color-heading-text),.9);
  }

  .sk-specs-{{ section.id }} .sk-specs__icon img{
    display:block;
    width:24px;
    height:24px;
    object-fit:contain;
  }

  .sk-specs-{{ section.id }} .sk-specs__text{
    min-width:0;
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .sk-specs-{{ section.id }} .sk-specs__title{
    font-family:var(--font-heading-family);
    font-weight:600;
    font-size:clamp(1.55rem, 0.6vw + 1.35rem, 1.9rem);
    line-height:1.25;
    color:rgb(var(--sk-color-heading-text));
    margin:0;
  }

  .sk-specs-{{ section.id }} .sk-specs__desc{
    font-family:var(--font-body-family);
    font-size:clamp(1.45rem, 0.5vw + 1.25rem, 1.8rem);
    line-height:1.6;
    color:rgba(var(--sk-color-body-text),.9);
    word-break:break-word;
  }

  /* Accordion */
  .sk-specs-{{ section.id }} .sk-specs__details{
    border-top:1px solid rgba(0,0,0,.10);
    background:rgba(255,255,255,.35);
  }

  .sk-specs-{{ section.id }} .sk-specs__summary{
    list-style:none;
    cursor:pointer;
    padding:clamp(16px, 1.6vw, 20px) clamp(16px, 2vw, 24px);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    font-family:var(--font-heading-family);
    font-weight:600;
    color:rgb(var(--sk-color-heading-text));
  }

  .sk-specs-{{ section.id }} .sk-specs__summary{
    transition:background-color .18s ease, text-decoration-color .18s ease;
  }

  .sk-specs-{{ section.id }} .sk-specs__summary:hover{
    background:rgba(0,0,0,.04);
    text-decoration:underline;
    text-underline-offset:3px;
    text-decoration-thickness:2px;
    text-decoration-color:rgba(var(--sk-color-heading-text),.5);
  }

  .sk-specs-{{ section.id }} .sk-specs__summary:focus-visible{
    background:rgba(0,0,0,.04);
    outline:2px solid var(--sk-brand);
    outline-offset:2px;
    text-decoration:underline;
    text-underline-offset:3px;
    text-decoration-thickness:2px;
  }

  .sk-specs-{{ section.id }} .sk-specs__summary::-webkit-details-marker{ display:none; }

  .sk-specs-{{ section.id }} .sk-specs__chev{
    width:12px;
    height:12px;
    border-right:2px solid rgba(var(--sk-color-heading-text),.7);
    border-bottom:2px solid rgba(var(--sk-color-heading-text),.7);
    transform:rotate(45deg);
    transition:transform .18s ease;
    margin-left:8px;
  }

  .sk-specs-{{ section.id }} details[open] .sk-specs__chev{
    transform:rotate(-135deg);
  }

  .sk-specs-{{ section.id }} .sk-specs__details-body{
    padding:0 24px 16px 24px;
    font-family:var(--font-body-family);
    color:rgba(var(--sk-color-body-text),.92);
    font-size:14px;
    line-height:1.6;
  }

  .sk-specs-{{ section.id }} .sk-specs__details-body p{ margin:8px 0 0 0; }
  .sk-specs-{{ section.id }} .sk-specs__details-body ul{ margin:8px 0 0 16px; }
  .sk-specs-{{ section.id }} .sk-specs__details-body li{ margin:8px 0; }

  /* ===== Tablet & Mobile ===== */
  @media (max-width:990px){
    .sk-specs-{{ section.id }}{
      padding:40px 0;
    }

    .sk-specs-{{ section.id }} .sk-specs__wrap{
      grid-template-columns:1fr;
      gap:16px;
    }

    .sk-specs-{{ section.id }} .sk-specs__media{
      height:auto;
      border-radius:16px;
      overflow:hidden;
    }

    .sk-specs-{{ section.id }} .sk-specs__img{
      width:100%;
      height:auto;
      aspect-ratio: 4 / 5;
      object-fit:cover;
      object-position:center;
    }

    .sk-specs-{{ section.id }} .sk-specs__media .sk-specs__model-media,
    .sk-specs-{{ section.id }} .sk-specs__media .media{
      aspect-ratio: 4 / 5;
      height:auto;
    }

    .sk-specs-{{ section.id }} .sk-specs__grid{
      grid-template-columns:1fr;
    }

    .sk-specs-{{ section.id }} .sk-specs__cell:nth-child(odd){
      border-right:none;
    }

    .sk-specs-{{ section.id }} .sk-specs__cell{
      display:grid !important;
      grid-template-columns:28px 1fr !important;
      align-items:start !important;
      padding:16px 16px;
      gap:12px;
      border-bottom:1px solid rgba(0,0,0,.09);
    }

    .sk-specs-{{ section.id }} .sk-specs__h{
      margin:8px 0 12px 0;
      font-size:22px;
      line-height:1.1;
      letter-spacing:.05em;
    }

    .sk-specs-{{ section.id }} .sk-specs__sub{
      margin:0 0 clamp(12px, 3vw, 16px) 0;
      font-size:15.5px;
      line-height:1.65;
      max-width:62ch;
    }

    .sk-specs-{{ section.id }} .sk-specs__card{
      border-radius:16px;
      background:rgba(0,0,0,.015);
      border-color:rgba(0,0,0,.09);
    }

    .sk-specs-{{ section.id }} .sk-specs__summary{
      padding:16px 16px;
      min-height:52px;
    }

    .sk-specs-{{ section.id }} .sk-specs__details-body{
      padding:0 16px 16px 16px;
      font-size:14px;
      line-height:1.65;
    }

    .sk-specs-{{ section.id }} .sk-specs__hint{
      left:12px;
      bottom:12px;
      font-size:12.5px;
      padding:8px 12px;
    }
  }

  @media (max-width:520px){
    .sk-specs-{{ section.id }} .sk-specs__img{
      aspect-ratio: 4 / 5;
    }
    .sk-specs-{{ section.id }} .sk-specs__media .sk-specs__model-media,
    .sk-specs-{{ section.id }} .sk-specs__media .media{
      aspect-ratio: 4 / 5;
    }
    .sk-specs-{{ section.id }} .sk-specs__h{
      font-size:20px;
    }
  }
</style>

{% liquid
  assign spec = null

  if section.settings.specification != blank
    assign spec = section.settings.specification
  elsif product and product.metafields.custom.product_specification != blank
    assign spec = product.metafields.custom.product_specification.value
  endif

  assign blocks = blank
  if spec != blank and spec.tech_details_blocks != blank
    assign blocks = spec.tech_details_blocks.value
  endif

  assign img = blank
  if spec != blank and spec.main_image != blank
    assign img = spec.main_image.value
  endif

  assign product_model = blank
  if product
    assign product_model = product.media | where: 'media_type', 'model' | first
  endif
%}

{% if spec != blank %}
  <section class="sk-specs-{{ section.id }}">
    <div class="page-width sk-specs__wrap">
      <!-- Left: Media -->
      <div class="sk-specs__media">
        {% if product_model != blank %}
          {{ product_model | media_tag: class: 'sk-specs__model-media', image_size: '1200x' }}

          <div id="sk-hint-{{ section.id }}" class="sk-specs__hint" aria-hidden="true">
            <span class="sk-specs__hint-dot"></span>
            <span>Trykk og dra for å rotere</span>
          </div>

          <script>
            (function () {
              var wrap = document.querySelector('.sk-specs-{{ section.id }} .sk-specs__media');
              var hint = document.getElementById('sk-hint-{{ section.id }}');
              if (!wrap || !hint) return;

              var hidden = false;
              var hide = function () {
                if (hidden) return;
                hidden = true;
                hint.classList.add('is-hidden');
              };

              wrap.addEventListener('pointerdown', hide, { passive: true });
              wrap.addEventListener('touchstart', hide, { passive: true });
              wrap.addEventListener('mousedown', hide);

              setTimeout(hide, 5500);
            })();
          </script>

        {% elsif img != blank %}
          <img
            class="sk-specs__img"
            src="{{ img | image_url: width: 1200 }}"
            alt="{{ spec.image_alt | default: product.title | escape }}"
            loading="lazy"
            width="{{ img.width }}"
            height="{{ img.height }}"
          >
        {% elsif product and product.featured_image != blank %}
          <img
            class="sk-specs__img"
            src="{{ product.featured_image | image_url: width: 1200 }}"
            alt="{{ product.title | escape }}"
            loading="lazy"
            width="{{ product.featured_image.width }}"
            height="{{ product.featured_image.height }}"
          >
        {% endif %}
      </div>

      <!-- Right: Content -->
      <div class="sk-specs__content">
        {% if spec.section_header != blank %}
          <h2 class="sk-specs__h">{{ spec.section_header }}</h2>
        {% endif %}

        {% if spec.subheader != blank %}
          <p class="sk-specs__sub">{{ spec.subheader }}</p>
        {% endif %}

        {% if blocks != blank and blocks.size > 0 %}
          <div class="sk-specs__card" role="region" aria-label="Hovedspesifikasjoner">
            <div class="sk-specs__grid">
              {% for b in blocks %}
                {% assign is_rich = false %}
                {% if b.content != blank %}
                  {% assign is_rich = true %}
                {% endif %}

                {% assign has_inline_list = false %}
                {% if is_rich %}
                  {% capture sk_specs_content_html %}{{ b.content | metafield_tag }}{% endcapture %}
                  {% if sk_specs_content_html contains '<ul' or sk_specs_content_html contains '<ol' %}
                    {% assign has_inline_list = true %}
                  {% endif %}
                {% endif %}

                <div class="sk-specs__cell{% if is_rich %} sk-specs__cell--wide{% endif %}{% if has_inline_list %} sk-specs__cell--inline-list{% endif %}">
                  <div class="sk-specs__icon">
                    {% assign icon_img = b.icon.value %}
                    {% if icon_img != blank %}
                      <img
                        src="{{ icon_img | image_url: width: 80 }}"
                        alt=""
                        loading="lazy"
                        width="24"
                        height="24"
                      >
                    {% else %}
                      <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true">
                        <path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm1 15h-2v-2h2v2Zm0-4h-2V7h2v6Z"/>
                      </svg>
                    {% endif %}
                  </div>

                  <div class="sk-specs__text">
                    {% if b.title != blank %}
                      <div class="sk-specs__title">{{ b.title }}</div>
                    {% endif %}

                    {% if b.content != blank %}
                      <div class="sk-specs__desc">
                        {{ b.content | metafield_tag }}
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>

            {% if spec.tech_spec_detailed_description != blank %}
              <details class="sk-specs__details">
                <summary class="sk-specs__summary">
                  <span>Tekniske detaljer</span>
                  <span class="sk-specs__chev" aria-hidden="true"></span>
                </summary>
                <div class="sk-specs__details-body">
                  {{ spec.tech_spec_detailed_description | metafield_tag }}
                </div>
              </details>
            {% endif %}
          </div>
        {% elsif spec.tech_spec_detailed_description != blank %}
          <div class="sk-specs__card">
            <details class="sk-specs__details" open>
              <summary class="sk-specs__summary">
                <span>Tekniske detaljer</span>
                <span class="sk-specs__chev" aria-hidden="true"></span>
              </summary>
              <div class="sk-specs__details-body">
                {{ spec.tech_spec_detailed_description | metafield_tag }}
              </div>
            </details>
          </div>
        {% endif %}
      </div>
    </div>
  </section>
{% endif %}

{% schema %}
{
  "name": "SK-Tech-spec",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "metaobject",
      "id": "specification",
      "label": "Product specification (metaobject)",
      "metaobject_type": "product_specification"
    }
  ],
  "presets": [
    {
      "name": "SK-Tech-spec (metaobject)"
    }
  ]
}
{% endschema %}
