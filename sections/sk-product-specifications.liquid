{% comment %}
  SECTION: Skinora – Product Specifications (Metaobject-driven)

  Metaobject type handle: product_specification (MUST match Shopify exactly)
  Fields:
  - section_header (single line text)
  - subheader (single line text)
  - main_image (file/image)        <-- used as poster / fallback
  - image_alt (single line text)
  - tech_details_blocks (list of metaobjects: tech_details_block)
      - title (single line)
      - content (rich text)
      - icon (file/image)
  - tech_spec_detailed_description (rich text)

  3D: Product media (GLB) is rendered natively via Shopify media_tag (best UX).

  PATCH: If odd number of tech cells, last cell becomes full-width on desktop (no fake filler).
{% endcomment %}

<style>
  /* ===== Base / Desktop ===== */
  .sk-specs-{{ section.id }}{
    background:#fff;
    padding:64px 0;
    margin:0;
  }

  .sk-specs-{{ section.id }} .sk-specs__wrap{
    display:grid;
    grid-template-columns:minmax(280px,520px) 1fr;
    gap:56px;
    align-items:start;
  }

  /* Controlled media height on desktop */
  .sk-specs-{{ section.id }} .sk-specs__media{
    position:relative;
    border-radius:18px;
    overflow:hidden;
    height:clamp(420px, 62vh, 640px);
    background: rgba(0,0,0,.02);
  }

  /* Image fills media box */
  .sk-specs-{{ section.id }} .sk-specs__img{
    width:100%;
    height:100%;
    display:block;
    object-fit:cover;
    object-position:center;
  }

  /* Shopify native 3D model media should fill the media box */
  .sk-specs-{{ section.id }} .sk-specs__media .sk-specs__model-media,
  .sk-specs-{{ section.id }} .sk-specs__media .media,
  .sk-specs-{{ section.id }} .sk-specs__media model-viewer,
  .sk-specs-{{ section.id }} .sk-specs__media .shopify-model-viewer-ui{
    width:100%;
    height:100%;
    display:block;
  }

  /* 3D hint overlay */
  .sk-specs-{{ section.id }} .sk-specs__hint{
    position:absolute;
    left:14px;
    bottom:14px;
    z-index:3;
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border-radius:999px;
    background:rgba(255,255,255,.88);
    border:1px solid rgba(0,0,0,.08);
    box-shadow:0 8px 24px rgba(0,0,0,.12);
    font-family:var(--font-body-family);
    font-size:13px;
    line-height:1;
    color:rgba(var(--sk-color-heading-text),.92);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    user-select:none;
    pointer-events:none; /* don’t block dragging the model */
  }

  .sk-specs-{{ section.id }} .sk-specs__hint-dot{
    width:8px;
    height:8px;
    border-radius:999px;
    background:rgba(var(--sk-color-heading-text),.55);
  }

  .sk-specs-{{ section.id }} .sk-specs__hint.is-hidden{
    opacity:0;
    transform:translateY(6px);
    transition:opacity .25s ease, transform .25s ease;
  }

  .sk-specs-{{ section.id }} .sk-specs__h{
    margin:0 0 10px 0;
    font-family:var(--font-heading-family);
    font-weight:600;
    letter-spacing:.06em;
    text-transform:uppercase;
    font-size:clamp(22px,2.2vw,34px);
    line-height:1.15;
    color:rgb(var(--sk-color-heading-text));
  }

  .sk-specs-{{ section.id }} .sk-specs__sub{
    margin:0 0 22px 0;
    max-width:58ch;
    font-family:var(--font-body-family);
    font-size:16px;
    line-height:1.6;
    color:rgba(var(--sk-color-body-text),.9);
  }

  /* Card */
  .sk-specs-{{ section.id }} .sk-specs__card{
    background:rgba(0,0,0,.02);
    border:1px solid rgba(0,0,0,.08);
    border-radius:16px;
    overflow:hidden;
  }

  .sk-specs-{{ section.id }} .sk-specs__grid{
    display:grid;
    grid-template-columns:1fr 1fr;
  }

  .sk-specs-{{ section.id }} .sk-specs__cell{
    display:grid;
    grid-template-columns:28px 1fr;
    gap:14px;
    padding:18px 20px;
    border-bottom:1px solid rgba(0,0,0,.08);
    align-items:start;
  }

  .sk-specs-{{ section.id }} .sk-specs__cell:nth-child(odd){
    border-right:1px solid rgba(0,0,0,.08);
  }

  /* PATCH: if odd number of cells, make the last one full width on desktop */
  @media (min-width: 991px){
    .sk-specs-{{ section.id }} .sk-specs__grid .sk-specs__cell:last-child:nth-child(odd){
      grid-column: 1 / -1;
      border-right: none;
    }
  }

  .sk-specs-{{ section.id }} .sk-specs__icon{
    width:28px;
    height:28px;
    display:grid;
    place-items:center;
    color:rgba(var(--sk-color-heading-text),.9);
  }

  .sk-specs-{{ section.id }} .sk-specs__icon img{
    display:block;
    width:24px;
    height:24px;
    object-fit:contain;
  }

  .sk-specs-{{ section.id }} .sk-specs__text{
    min-width:0;
  }

  .sk-specs-{{ section.id }} .sk-specs__title{
    font-family:var(--font-heading-family);
    font-weight:600;
    font-size:15px;
    line-height:1.2;
    color:rgb(var(--sk-color-heading-text));
    margin-bottom:6px;
  }

  .sk-specs-{{ section.id }} .sk-specs__desc{
    font-family:var(--font-body-family);
    font-size:14px;
    line-height:1.5;
    color:rgba(var(--sk-color-body-text),.9);
    word-break:break-word;
  }

  /* Rich text hygiene */
  .sk-specs-{{ section.id }} .sk-specs__desc p{ margin:0; }
  .sk-specs-{{ section.id }} .sk-specs__desc p + p{ margin-top:6px; }
  .sk-specs-{{ section.id }} .sk-specs__desc ul{ margin:8px 0 0 18px; }
  .sk-specs-{{ section.id }} .sk-specs__desc li{ margin:6px 0; }

  /* Accordion */
  .sk-specs-{{ section.id }} .sk-specs__details{
    border-top:1px solid rgba(0,0,0,.08);
    background:rgba(255,255,255,.35);
  }

  .sk-specs-{{ section.id }} .sk-specs__summary{
    list-style:none;
    cursor:pointer;
    padding:16px 20px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    font-family:var(--font-heading-family);
    font-weight:600;
    color:rgb(var(--sk-color-heading-text));
  }

  .sk-specs-{{ section.id }} .sk-specs__summary::-webkit-details-marker{ display:none; }

  .sk-specs-{{ section.id }} .sk-specs__chev{
    width:10px;
    height:10px;
    border-right:2px solid rgba(var(--sk-color-heading-text),.7);
    border-bottom:2px solid rgba(var(--sk-color-heading-text),.7);
    transform:rotate(45deg);
    transition:transform .18s ease;
    margin-left:8px;
  }

  .sk-specs-{{ section.id }} details[open] .sk-specs__chev{
    transform:rotate(-135deg);
  }

  .sk-specs-{{ section.id }} .sk-specs__details-body{
    padding:0 20px 18px 20px;
    font-family:var(--font-body-family);
    color:rgba(var(--sk-color-body-text),.92);
    font-size:14px;
    line-height:1.6;
  }

  .sk-specs-{{ section.id }} .sk-specs__details-body p{ margin:10px 0 0 0; }
  .sk-specs-{{ section.id }} .sk-specs__details-body ul{ margin:10px 0 0 18px; }
  .sk-specs-{{ section.id }} .sk-specs__details-body li{ margin:6px 0; }

  /* ===== Tablet & Mobile ===== */
  @media (max-width:990px){
    .sk-specs-{{ section.id }}{
      padding:42px 0;
    }

    .sk-specs-{{ section.id }} .sk-specs__wrap{
      grid-template-columns:1fr;
      gap:18px;
    }

    .sk-specs-{{ section.id }} .sk-specs__media{
      height:auto;
      border-radius:18px;
      overflow:hidden;
    }

    /* Consistent shape on mobile for image + 3D container */
    .sk-specs-{{ section.id }} .sk-specs__img{
      width:100%;
      height:auto;
      aspect-ratio: 4 / 3;
      object-fit:cover;
      object-position:center;
    }

    /* Force a stable box for Shopify's 3D UI on mobile */
    .sk-specs-{{ section.id }} .sk-specs__media .sk-specs__model-media,
    .sk-specs-{{ section.id }} .sk-specs__media .media{
      aspect-ratio: 4 / 3;
      height:auto;
    }

    .sk-specs-{{ section.id }} .sk-specs__grid{
      grid-template-columns:1fr;
    }

    .sk-specs-{{ section.id }} .sk-specs__cell:nth-child(odd){
      border-right:none;
    }

    /* Hardening against theme overrides */
    .sk-specs-{{ section.id }} .sk-specs__cell{
      display:grid !important;
      grid-template-columns:28px 1fr !important;
      align-items:start !important;
      padding:14px 16px;
      gap:12px;
      border-bottom:1px solid rgba(0,0,0,.07);
    }

    .sk-specs-{{ section.id }} .sk-specs__h{
      margin:6px 0 10px 0;
      font-size:22px;
      line-height:1.1;
      letter-spacing:.05em;
    }

    .sk-specs-{{ section.id }} .sk-specs__sub{
      margin:0 0 clamp(12px, 3vw, 16px) 0;
      font-size:15.5px;
      line-height:1.65;
      max-width:62ch;
    }

    .sk-specs-{{ section.id }} .sk-specs__card{
      border-radius:18px;
      background:rgba(0,0,0,.015);
      border-color:rgba(0,0,0,.07);
    }

    .sk-specs-{{ section.id }} .sk-specs__summary{
      padding:16px 16px;
      min-height:52px;
    }

    .sk-specs-{{ section.id }} .sk-specs__details-body{
      padding:0 16px 16px 16px;
      font-size:14px;
      line-height:1.65;
    }

    .sk-specs-{{ section.id }} .sk-specs__hint{
      left:12px;
      bottom:12px;
      font-size:12.5px;
      padding:9px 11px;
    }
  }

  @media (max-width:520px){
    .sk-specs-{{ section.id }} .sk-specs__img{
      aspect-ratio: 3 / 2;
    }
    .sk-specs-{{ section.id }} .sk-specs__media .sk-specs__model-media,
    .sk-specs-{{ section.id }} .sk-specs__media .media{
      aspect-ratio: 3 / 2;
    }
    .sk-specs-{{ section.id }} .sk-specs__h{
      font-size:20px;
    }
  }
</style>

{% liquid
  assign spec = null

  if section.settings.specification != blank
    assign spec = section.settings.specification
  elsif product and product.metafields.custom.product_specification != blank
    assign spec = product.metafields.custom.product_specification.value
  endif

  assign blocks = blank
  if spec != blank and spec.tech_details_blocks != blank
    assign blocks = spec.tech_details_blocks.value
  endif

  assign img = blank
  if spec != blank and spec.main_image != blank
    assign img = spec.main_image.value
  endif

  assign product_model = blank
  if product
    assign product_model = product.media | where: 'media_type', 'model' | first
  endif
%}

{% if spec != blank %}
  <section class="sk-specs-{{ section.id }}">
    <div class="page-width sk-specs__wrap">
      <!-- Left: Media (Shopify native 3D model if present; otherwise image fallback) -->
      <div class="sk-specs__media">
        {% if product_model != blank %}
          {{ product_model | media_tag: class: 'sk-specs__model-media', image_size: '1200x' }}

          <div id="sk-hint-{{ section.id }}" class="sk-specs__hint" aria-hidden="true">
            <span class="sk-specs__hint-dot"></span>
            <span>Trykk og dra for å rotere</span>
          </div>

          <script>
            (function () {
              var wrap = document.querySelector('.sk-specs-{{ section.id }} .sk-specs__media');
              var hint = document.getElementById('sk-hint-{{ section.id }}');
              if (!wrap || !hint) return;

              var hidden = false;
              var hide = function () {
                if (hidden) return;
                hidden = true;
                hint.classList.add('is-hidden');
              };

              wrap.addEventListener('pointerdown', hide, { passive: true });
              wrap.addEventListener('touchstart', hide, { passive: true });
              wrap.addEventListener('mousedown', hide);

              setTimeout(hide, 5500);
            })();
          </script>

        {% elsif img != blank %}
          <img
            class="sk-specs__img"
            src="{{ img | image_url: width: 1200 }}"
            alt="{{ spec.image_alt | default: product.title | escape }}"
            loading="lazy"
            width="{{ img.width }}"
            height="{{ img.height }}"
          >
        {% elsif product and product.featured_image != blank %}
          <img
            class="sk-specs__img"
            src="{{ product.featured_image | image_url: width: 1200 }}"
            alt="{{ product.title | escape }}"
            loading="lazy"
            width="{{ product.featured_image.width }}"
            height="{{ product.featured_image.height }}"
          >
        {% endif %}
      </div>

      <!-- Right: Content -->
      <div class="sk-specs__content">
        {% if spec.section_header != blank %}
          <h2 class="sk-specs__h">{{ spec.section_header }}</h2>
        {% endif %}

        {% if spec.subheader != blank %}
          <p class="sk-specs__sub">{{ spec.subheader }}</p>
        {% endif %}

        {% if blocks != blank and blocks.size > 0 %}
          <div class="sk-specs__card" role="region" aria-label="Hovedspesifikasjoner">
            <div class="sk-specs__grid">
              {% for b in blocks %}
                <div class="sk-specs__cell">
                  <div class="sk-specs__icon">
                    {% assign icon_img = b.icon.value %}
                    {% if icon_img != blank %}
                      <img
                        src="{{ icon_img | image_url: width: 80 }}"
                        alt=""
                        loading="lazy"
                        width="24"
                        height="24"
                      >
                    {% else %}
                      <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true">
                        <path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm1 15h-2v-2h2v2Zm0-4h-2V7h2v6Z"/>
                      </svg>
                    {% endif %}
                  </div>

                  <div class="sk-specs__text">
                    {% if b.title != blank %}
                      <div class="sk-specs__title">{{ b.title }}</div>
                    {% endif %}

                    {% if b.content != blank %}
                      <div class="sk-specs__desc">
                        {{ b.content | metafield_tag }}
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>

            {% if spec.tech_spec_detailed_description != blank %}
              <details class="sk-specs__details">
                <summary class="sk-specs__summary">
                  <span>Tekniske detaljer</span>
                  <span class="sk-specs__chev" aria-hidden="true"></span>
                </summary>
                <div class="sk-specs__details-body">
                  {{ spec.tech_spec_detailed_description | metafield_tag }}
                </div>
              </details>
            {% endif %}
          </div>
        {% elsif spec.tech_spec_detailed_description != blank %}
          <div class="sk-specs__card">
            <details class="sk-specs__details" open>
              <summary class="sk-specs__summary">
                <span>Tekniske detaljer</span>
                <span class="sk-specs__chev" aria-hidden="true"></span>
              </summary>
              <div class="sk-specs__details-body">
                {{ spec.tech_spec_detailed_description | metafield_tag }}
              </div>
            </details>
          </div>
        {% endif %}
      </div>
    </div>
  </section>
{% endif %}

{% schema %}
{
  "name": "SK-Tech-spec",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "metaobject",
      "id": "specification",
      "label": "Product specification (metaobject)",
      "metaobject_type": "product_specification"
    }
  ],
  "presets": [
    {
      "name": "SK-Tech-spec (metaobject)"
    }
  ]
}
{% endschema %}
